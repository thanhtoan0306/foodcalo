<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FoodCalo - Phân Tích Dinh Dưỡng</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #2ecc71;
            --secondary-color: #27ae60;
            --background-color: #f8f9fa;
            --text-color: #2c3e50;
            --border-radius: 15px;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .upload-container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            border-radius: var(--border-radius);
            background: white;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .app-title {
            color: var(--primary-color);
            font-weight: 700;
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .app-subtitle {
            color: var(--text-color);
            font-size: 1.2rem;
            opacity: 0.8;
            margin-bottom: 2rem;
        }

        .upload-area {
            border: 2px dashed #ddd;
            border-radius: var(--border-radius);
            padding: 2rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            margin-bottom: 2rem;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
        }

        .upload-area::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: var(--border-radius);
            background: linear-gradient(45deg, rgba(46, 204, 113, 0.1), rgba(46, 204, 113, 0.05));
            z-index: -1;
        }

        .upload-area:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
        }

        .food-name-section {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 1.5rem;
            border-radius: var(--border-radius);
            margin-bottom: 2rem;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .food-name {
            font-size: 1.8rem;
            font-weight: 700;
            margin: 0;
        }

        .upload-icon {
            font-size: 2.5rem;
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 1rem;
        }

        .preview-image {
            max-width: 100%;
            max-height: 400px;
            margin: 1rem auto;
            border-radius: var(--border-radius);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            display: block;
        }

        .nutrition-card {
            background: white;
            padding: 2rem;
            border-radius: var(--border-radius);
            margin-top: 2rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }

        .nutrition-item {
            margin: 1.5rem 0;
            padding: 1rem;
            border-radius: 10px;
            background: var(--background-color);
            transition: all 0.3s ease;
        }

        .nutrition-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .nutrition-value {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary-color);
        }

        .nutrition-detail {
            padding: 0.8rem;
            margin: 0.5rem 0;
            background: white;
            border-radius: 8px;
            border-left: 3px solid var(--primary-color);
            transition: all 0.3s ease;
        }

        .nutrition-detail:hover {
            transform: translateX(5px);
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .advice-section {
            margin-top: 2rem;
            padding: 1.5rem;
            background: var(--background-color);
            border-radius: var(--border-radius);
            border-left: 5px solid var(--primary-color);
            line-height: 1.6;
        }

        .advice-section strong {
            color: var(--primary-color);
        }

        .advice-section em {
            color: var(--secondary-color);
            font-style: italic;
        }

        .loading {
            display: none;
            text-align: center;
            margin: 2rem 0;
        }

        .loading .spinner-border {
            width: 3rem;
            height: 3rem;
            color: var(--primary-color);
        }

        .btn-analyze {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            border: none;
            padding: 0.8rem 2rem;
            font-size: 1.1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            border-radius: 50px;
            color: white;
            box-shadow: 0 5px 15px rgba(46, 204, 113, 0.3);
        }

        .btn-analyze:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(46, 204, 113, 0.4);
            background: linear-gradient(45deg, var(--secondary-color), var(--primary-color));
        }

        .supported-formats {
            font-size: 0.9rem;
            color: #666;
            margin-top: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="upload-container">
            <h1 class="text-center app-title">FoodCalo</h1>
            <h4 class="text-center app-subtitle">Phân Tích Dinh Dưỡng Thực Phẩm Thông Minh</h4>
            
            <form id="uploadForm" class="mb-4">
                <div class="upload-area" id="dropZone">
                    <i class="fas fa-cloud-upload-alt upload-icon"></i>
                    <h5>Kéo thả ảnh vào đây hoặc click để chọn</h5>
                    <input type="file" class="d-none" id="foodImage" accept=".jpg,.jpeg,.png,.gif,.bmp,.webp" required>
                    <p class="supported-formats">Định dạng hỗ trợ: JPG, JPEG, PNG, GIF, BMP, WEBP</p>
                </div>
                <div class="text-center">
                    <img id="imagePreview" class="preview-image d-none" alt="Preview">
                    <button type="submit" class="btn btn-primary btn-analyze">
                        <i class="fas fa-search me-2"></i>Phân Tích
                    </button>
                </div>
            </form>

            <div id="loading" class="loading">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Đang xử lý...</span>
                </div>
                <p class="mt-3">Đang phân tích ảnh của bạn...</p>
            </div>

            <div id="results" class="d-none">
                <div class="food-name-section">
                    <h3 class="food-name" id="foodName">Tên món ăn</h3>
                </div>
                
                <div class="nutrition-card">
                    <h5 class="text-center mb-4">
                        <i class="fas fa-chart-pie me-2"></i>
                        Thông Tin Dinh Dưỡng
                    </h5>
                    <div class="nutrition-item">
                        <strong><i class="fas fa-fire me-2"></i>Calories:</strong>
                        <span id="calories" class="nutrition-value">0</span> kcal
                    </div>
                    <div class="nutrition-item">
                        <strong><i class="fas fa-candy-cane me-2"></i>Đường:</strong>
                        <span id="sugar" class="nutrition-value">0</span> g
                    </div>
                    <div class="nutrition-item">
                        <strong><i class="fas fa-oil-can me-2"></i>Chất béo:</strong>
                        <span id="fat" class="nutrition-value">0</span> g
                    </div>
                    <div class="nutrition-item">
                        <strong><i class="fas fa-flask me-2"></i>Chất dinh dưỡng khác:</strong>
                        <div id="nutrients" class="mt-2"></div>
                    </div>
                </div>

                <div class="advice-section">
                    <h5 class="mb-3">
                        <i class="fas fa-lightbulb me-2"></i>
                        Lời Khuyên Dinh Dưỡng
                    </h5>
                    <p id="advice" class="mb-0"></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const GOOGLE_API_KEY = 'AIzaSyAcVFMSkAQB0fEt6_dEjOFNdqj7V8_ZXc4';

        // Xử lý kéo thả
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('foodImage');

        dropZone.addEventListener('click', () => fileInput.click());

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.style.borderColor = '#2ecc71';
            dropZone.style.backgroundColor = 'rgba(46, 204, 113, 0.1)';
        });

        dropZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dropZone.style.borderColor = '#ddd';
            dropZone.style.backgroundColor = 'transparent';
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.style.borderColor = '#ddd';
            dropZone.style.backgroundColor = 'transparent';
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                if (isValidImageFile(file)) {
                    fileInput.files = files;
                    handleImagePreview(file);
                } else {
                    alert('Vui lòng chọn file ảnh đúng định dạng (JPG, JPEG, PNG, GIF, BMP, WEBP)');
                }
            }
        });

        function isValidImageFile(file) {
            const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/bmp', 'image/webp'];
            return validTypes.includes(file.type);
        }

        function handleImagePreview(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('imagePreview');
                preview.src = e.target.result;
                preview.classList.remove('d-none');
            }
            reader.readAsDataURL(file);
        }

        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file && isValidImageFile(file)) {
                handleImagePreview(file);
            } else if (file) {
                alert('Vui lòng chọn file ảnh đúng định dạng (JPG, JPEG, PNG, GIF, BMP, WEBP)');
                fileInput.value = '';
            }
        });

        document.getElementById('uploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Vui lòng chọn một ảnh');
                return;
            }

            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').classList.add('d-none');

            try {
                const base64Image = await new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = () => {
                        const base64 = reader.result.split(',')[1];
                        resolve(base64);
                    };
                    reader.readAsDataURL(file);
                });

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GOOGLE_API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                {text: `Với vai trò là một chuyên gia dinh dưỡng học, hãy phân tích hình ảnh món ăn này và cung cấp thông tin chi tiết theo định dạng JSON như sau:
{
    "foodName": "Tên món ăn",
    "calories": "Số calories (nếu không chắc chắn, hãy ước tính dựa trên thành phần)",
    "sugar": "Lượng đường (g) (nếu không chắc chắn, hãy ước tính)",
    "fat": "Lượng chất béo (g) (nếu không chắc chắn, hãy ước tính)",
    "nutrients": "Liệt kê các chất dinh dưỡng quan trọng khác như protein, chất xơ, vitamin, khoáng chất",
    "advice": "Đưa ra lời khuyên chi tiết về giá trị dinh dưỡng, đối tượng nên/không nên sử dụng, thời điểm nên dùng, và cách kết hợp với các thực phẩm khác để tối ưu dinh dưỡng"
}`},
                                {
                                    inline_data: {
                                        mime_type: file.type,
                                        data: base64Image
                                    }
                                }
                            ]
                        }]
                    })
                });

                const result = await response.json();
                
                let nutritionData;
                try {
                    // Lấy text JSON từ phản hồi API và loại bỏ các ký tự markdown
                    const jsonText = result.candidates[0].content.parts[0].text
                        .replace('```json\n', '')
                        .replace('\n```', '');
                    
                    nutritionData = JSON.parse(jsonText);

                    // Xử lý dữ liệu nutrients nếu là object
                    if (typeof nutritionData.nutrients === 'object') {
                        nutritionData.nutrients = Object.entries(nutritionData.nutrients)
                            .map(([key, value]) => `<div class="nutrition-detail">
                                <strong>${key}:</strong> ${value}
                            </div>`)
                            .join('');
                    }

                    // Xử lý advice để hiển thị markdown
                    if (nutritionData.advice) {
                        nutritionData.advice = nutritionData.advice
                            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // Bold text
                            .replace(/\*(.*?)\*/g, '<em>$1</em>') // Italic text
                            .replace(/\n\n/g, '<br><br>') // Line breaks
                            .replace(/\n\* /g, '<br>• '); // Bullet points
                    }

                } catch (error) {
                    console.error('Error parsing API response:', error);
                    nutritionData = {
                        foodName: 'Không thể nhận diện món ăn',
                        calories: '0',
                        sugar: '0g',
                        fat: '0g',
                        nutrients: 'Chưa có thông tin chi tiết',
                        advice: 'Không thể đưa ra lời khuyên cụ thể. Vui lòng tham khảo ý kiến chuyên gia dinh dưỡng.'
                    };
                }

                // Cập nhật UI với kết quả
                document.getElementById('foodName').textContent = nutritionData.foodName || 'Không xác định';
                document.getElementById('calories').textContent = nutritionData.calories || '0';
                document.getElementById('sugar').textContent = nutritionData.sugar || '0g';
                document.getElementById('fat').textContent = nutritionData.fat || '0g';
                document.getElementById('nutrients').innerHTML = nutritionData.nutrients || 'Không có thông tin';
                document.getElementById('advice').innerHTML = nutritionData.advice || 'Không có lời khuyên';

                document.getElementById('results').classList.remove('d-none');
            } catch (error) {
                alert('Có lỗi xảy ra khi phân tích ảnh. Vui lòng thử lại.');
                console.error('Error:', error);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html> 